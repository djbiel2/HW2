<html>
<head>
<title>Vocabulary_Writer.scala</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #56a8f5;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #00b8bb; font-weight: bold;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Vocabulary_Writer.scala</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.{</span><span class="s1">File</span><span class="s2">, </span><span class="s1">PrintWriter</span><span class="s2">}</span>
<span class="s0">import </span><span class="s1">scala</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">Source</span>
<span class="s0">import </span><span class="s1">scala</span><span class="s2">.</span><span class="s1">collection</span><span class="s2">.</span><span class="s1">mutable</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">slf4j</span><span class="s2">.</span><span class="s1">LoggerFactory</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">typesafe</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ConfigFactory</span>

<span class="s0">object </span><span class="s2">Vocabulary_Writer {</span>

  <span class="s3">//logger</span>
  <span class="s0">private val </span><span class="s2">logger = </span><span class="s1">LoggerFactory</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">Vocabulary_Writer</span><span class="s2">.</span><span class="s1">getClass</span><span class="s2">)</span>


  <span class="s3">// Create vocabulary word frequencies</span>

  <span class="s0">def </span><span class="s4">generate_vocabulary_with_frequency</span><span class="s2">(</span><span class="s1">shard_dir: String</span><span class="s2">, </span><span class="s1">output_file_path: String</span><span class="s2">)</span><span class="s1">: Unit </span><span class="s2">= {</span>
    <span class="s0">try </span><span class="s2">{</span>
      <span class="s3">// use map to store frequenices</span>
      <span class="s0">val </span><span class="s2">word_frequency = </span><span class="s1">mutable</span><span class="s2">.</span><span class="s1">Map</span><span class="s2">[</span><span class="s1">String</span><span class="s2">, </span><span class="s1">Int</span><span class="s2">]().</span><span class="s1">withDefaultValue</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>


      <span class="s0">val </span><span class="s2">shard_directory = </span><span class="s0">new </span><span class="s1">File</span><span class="s2">(</span><span class="s1">shard_dir</span><span class="s2">)</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">!shard_directory</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">() </span><span class="s1">|| !shard_directory</span><span class="s2">.</span><span class="s1">isDirectory</span><span class="s2">) {</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s6">s&quot;Shard file not found, error&quot;</span><span class="s2">)</span>
        <span class="s0">return</span>
      <span class="s2">}</span>

      <span class="s0">val </span><span class="s2">shard_files = </span><span class="s1">shard_directory</span><span class="s2">.</span><span class="s1">listFiles</span><span class="s2">().</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">_</span><span class="s2">.</span><span class="s1">isFile</span><span class="s2">).</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">_</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s6">&quot;shard_&quot;</span><span class="s2">))</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">shard_files</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">) {</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">s&quot;No shard files in file, error&quot;</span><span class="s2">)</span>
        <span class="s0">return</span>
      <span class="s2">}</span>

      <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s6">s&quot;Processing shards&quot;</span><span class="s2">)</span>

      <span class="s3">// go though each shard and count freqencies</span>
      <span class="s1">shard_files</span><span class="s2">.</span><span class="s1">foreach </span><span class="s2">{ </span><span class="s1">shard_file </span><span class="s2">=&gt;</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s6">s&quot;Shard- </span><span class="s7">$</span><span class="s2">{</span><span class="s1">shard_file</span><span class="s2">.</span><span class="s1">getName</span><span class="s2">}</span><span class="s6">&quot;</span><span class="s2">)</span>
        <span class="s0">val </span><span class="s2">source = </span><span class="s1">Source</span><span class="s2">.</span><span class="s1">fromFile</span><span class="s2">(</span><span class="s1">shard_file</span><span class="s2">)</span>
        <span class="s1">source</span><span class="s2">.</span><span class="s1">getLines</span><span class="s2">().</span><span class="s1">foreach </span><span class="s2">{ </span><span class="s1">line </span><span class="s2">=&gt;</span>
          <span class="s0">val </span><span class="s2">words = </span><span class="s1">line</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">&quot;</span><span class="s0">\\</span><span class="s6">s+&quot;</span><span class="s2">).</span><span class="s1">map</span><span class="s2">(</span><span class="s1">_</span><span class="s2">.</span><span class="s1">replaceAll</span><span class="s2">(</span><span class="s6">&quot;[^a-zA-Z]&quot;</span><span class="s2">, </span><span class="s6">&quot;&quot;</span><span class="s2">).</span><span class="s1">toLowerCase</span><span class="s2">).</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">_</span><span class="s2">.</span><span class="s1">nonEmpty</span><span class="s2">)</span>

          <span class="s1">words</span><span class="s2">.</span><span class="s1">foreach </span><span class="s2">{ </span><span class="s1">word </span><span class="s2">=&gt;</span>
            <span class="s1">word_frequency</span><span class="s2">(</span><span class="s1">word</span><span class="s2">) </span><span class="s1">+= </span><span class="s5">1</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
        <span class="s1">source</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
      <span class="s2">}</span>

      <span class="s3">//Write the vocabulary to output</span>
      <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s6">s&quot;Printing vocabulary with word freqencies to </span><span class="s7">$</span><span class="s1">output_file_path</span><span class="s6">&quot;</span><span class="s2">)</span>
      <span class="s0">val </span><span class="s2">writer = </span><span class="s0">new </span><span class="s1">PrintWriter</span><span class="s2">(</span><span class="s0">new </span><span class="s1">File</span><span class="s2">(</span><span class="s1">output_file_path</span><span class="s2">))</span>
      <span class="s1">writer</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s6">&quot;Word,Frequency&quot;</span><span class="s2">)</span>
      <span class="s1">word_frequency</span><span class="s2">.</span><span class="s1">foreach </span><span class="s2">{</span>
        <span class="s0">case </span><span class="s2">(</span><span class="s1">word</span><span class="s2">, </span><span class="s1">frequency</span><span class="s2">) =&gt;</span>
          <span class="s1">writer</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s6">s&quot;</span><span class="s7">$</span><span class="s1">word</span><span class="s6">,</span><span class="s7">$</span><span class="s1">frequency</span><span class="s6">&quot;</span><span class="s2">)</span>
      <span class="s2">}</span>
      <span class="s1">writer</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
      <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s6">&quot;Vocabulary creating successful&quot;</span><span class="s2">)</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">{</span>
      <span class="s0">case </span><span class="s1">e: Exception </span><span class="s2">=&gt;</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s6">&quot;Vocabulary creation error&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
    <span class="s2">}</span>
  <span class="s2">}</span>



  <span class="s0">def </span><span class="s4">main</span><span class="s2">(</span><span class="s1">args: Array</span><span class="s2">[</span><span class="s1">String</span><span class="s2">])</span><span class="s1">: Unit </span><span class="s2">= {</span>
    <span class="s3">//load configs</span>
    <span class="s0">val </span><span class="s2">config = </span><span class="s1">ConfigFactory</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>
    <span class="s0">val </span><span class="s2">shard_dir = </span><span class="s1">config</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s6">&quot;vocabulary_writer.shard_dir&quot;</span><span class="s2">)</span>
    <span class="s0">val </span><span class="s2">output_file_path = </span><span class="s1">config</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s6">&quot;vocabulary_writer.output_file_path&quot;</span><span class="s2">)</span>

    <span class="s3">//generate vocabulary with freqency</span>
    <span class="s1">generate_vocabulary_with_frequency</span><span class="s2">(</span><span class="s1">shard_dir</span><span class="s2">, </span><span class="s1">output_file_path</span><span class="s2">)</span>
  <span class="s2">}</span>
<span class="s2">}</span>
</pre>
</body>
</html>